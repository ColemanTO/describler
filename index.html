<doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Describler</title>
  <link rel="shortcut icon" href="favicon.ico">
  <style> 
    @font-face {
      font-family: "Galberik";
      src: url("assets/Galberik.eot");
      src: local("☺"), 
        url("assets/Galberik.woff") format("woff"), 
        url("assets/Galberik.ttf") format("truetype"), 
        url("assets/Galberik.svg") format("svg");
      font-weight: normal;
      font-style: normal;
    }

    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: Calibri, Verdana, sans-serif;
    }

    h1 {
      font-family: "Galberik", cursive;      
      font-style: italic;
      font-weight: bold;
      text-transform: lowercase;
      font-size: 1.5em;
      color: whitesmoke;
      margin: 2px 0em 10px 0em;
    }

    h2 {
      font-size: 1.25em;
      color: dimgray;      
    }

    section#app {
      font-size: 18px;
      background-image: url(assets/tweed.png);
      padding: 0.1em 1em 2em 1em;
    }

    section#content {
      background-image: url(assets/pixel_weave.png);
      border-radius: 3px;
      box-shadow: inset 0 0 10px #333;
      padding: 0.5em;
      margin: 0;
      /*padding: 0;*/
    }

    section#controls {
      float: left;
      width: 20%;
/*      margin: 0 1em 0 0;
      padding: 0;
      margin: 0 !important;*/
    }

    article#display-area {
      margin-left: 20%;
      height: 88%;
      overflow-y: auto;
      padding: 0em 2em 0em 1em;
    }

    section#lightboxes {
      display: none;
    }

    .upload {
      position: relative;
      cursor: pointer;
    }

      .upload input {
        position: absolute;
        top: 0;
        right: 0;
        font-size: 1em;
        opacity: 0;
        cursor: pointer;
        width: 14em;
      }

      select {
        width: 14em;
        padding: 0.25em;
        height: 2em;      
        border-radius: 10em;     
      }

    .button, button {
      font-family: "icomoon", "Overlock", sans-serif;
      font-size: 1em;
      display: inline-block;
      margin: 0.15em;
      outline: none;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      padding: .5em 2em .3em;
      text-shadow: 0 1px 1px rgba(0,0,0,.3);
      box-shadow: 0 1px 2px rgba(0,0,0,.2);
      border: solid 1px #da7c0c;
      border-radius: 8px;
    }

    .button > span, button > span {
      margin-left: 0.5em;
    }

    .button:hover {
      text-decoration: none;
    }

    .button:active {
      position: relative;
      top: 1px;
    }

    .upload {
      color: #fef4e9;
      border: solid 1px #da7c0c;
      background: hsl(31, 93%, 54%); /* Old browsers */
      background: linear-gradient(top, #faa51a 35%, #f47a20 100%)
    }
      
      .upload:hover {
        background: #f47c20;
        background: linear-gradient(top, #f88e11 35%, #f06015 100%)
      }
      
      .upload:active {
        color: #fcd3a5;
        background: linear-gradient(top, #f47a20 35%, #faa51a 100%)
      }

    .download {
      color: hsl(284, 65%, 91%);
      border: solid 1px hsl(283, 100%, 32%);
      background: hsl(282, 100%, 40%); /* Old browsers */
      background: linear-gradient(top, hsl(282, 100%, 47%) 35%, hsl(282, 100%, 32%) 100%)
    }      
     
      .download:hover {
        background: hsl(282, 100%, 34%);
        background: linear-gradient(top, hsl(282, 100%, 40%) 35%, hsl(282, 100%, 28%) 100%)
      }
      
      .download:active {
        color: hsl(282, 100%, 47%);
        background: linear-gradient(top, hsl(282, 100%, 32%) 35%, hsl(282, 100%, 47%) 100%)
      }      


    section#info {
      margin: 0.5em;
      padding: 0.5em;
      background-color: whitesmoke;
      width: 10em;
      box-shadow: 3px 3px 5px 6px #ccc;
    }  
      
      output {
        display: block;
        font-style: italic;
      }
  </style>
	
	<script src="describler.js"> </script>
  <script defer>
    window.onload = function () {
      var app = new appObj();
    }

    // window.onload = new appObj();
    // var app = new appObj();

    function appObj() {
      this.svgroot = null;
      this.describler = null;

      this.file = null;

      this.displayArea = document.getElementById( "display-area" );
      this.downloadLink = document.getElementById( "download-button" );
      this.selectFileButton = document.getElementById( "select_file-button" );
      this.uploadFileButton = document.getElementById( "upload_file-button" );
      this.codeView = document.querySelector("#code-view code");

      this.lang = "en-US";

      this.sampleList = [
        "aria-bar-chart.svg",
        "aria-pie-chart.svg",
        "barchart-labels.svg",
        "barchart-text-only.svg",
        "simple-car.svg"
      ];
   

      // constants
      this.svgns = "http://www.w3.org/2000/svg";
      this.xlinkns = "http://www.w3.org/1999/xlink";

      /*
      // initialize controls
      */

      // populate sample file list dropdown
      for(var i = 0; i < this.sampleList.length; i++) {
        var option = this.sampleList[i];
        var optionEl = document.createElement("option");
        optionEl.textContent = (i + 1) + ". " + option;
        optionEl.value = option;
        this.selectFileButton.appendChild(optionEl);
      }

      this.selectFileButton.addEventListener("change", bind(this, this.loadFileFromServer), false);
      this.uploadFileButton.addEventListener("change", bind(this, this.uploadFile), false);
    }

    appObj.prototype.loadFileFromServer = function (){
      this.file = {
        "name": event.target.value
      }

      var xhr = new XMLHttpRequest;
      xhr.open("GET", "samples/" + this.file.name);
      xhr.onload = bind(this, this.insertFile);;
      // xhr.onload = this.insertFile;
      xhr.send()
    }

    appObj.prototype.uploadFile = function (event){
      this.file = event.target.files[0]; // FileList object

      // only allow SVG files
      if ("image/svg+xml" == this.file.type) {
        var reader = new FileReader();
        reader.readAsText(this.file);
        reader.onload = bind(this, this.insertFile);
      }
    }

    appObj.prototype.insertFile = function (event){
      // try to use FileReader file
      var svgContent = event.target.result;
      if ( !svgContent ) { 
        // otherwise use XHR file
        svgContent = this.response;
      }

      if ( svgContent ) { 
        var fileSize = (this.file.size ? this.file.size : "n/a");
        var lastMod = (this.file.lastModifiedDate ? this.file.lastModifiedDate.toLocaleDateString() : "n/a");
        this.setFileInfo( this.file.name, fileSize, lastMod );

        // strip off XML prolog 
        var svgStart = svgContent.indexOf("<svg");
        var prolog = svgContent.substring(0, (svgStart - 1));
        svgContent = svgContent.substring( svgStart );
        
        // insert SVG file into HTML page
        this.displayArea.innerHTML = svgContent;
        this.svgroot = this.displayArea.firstElementChild;

        // initialize download link
        this.createSaveLink( svgContent );
        // this.createSaveLink( this.displayArea.innerHTML );

        // optimizations
        this.setScalability( this.svgroot );
        
        this.lang = "en-US";
        var langAttr = this.svgroot.getAttribute("lang");
        if (langAttr) {
          this.lang = langAttr;
        }

        // write source code to lightbox
        this.writeSource();

        // invoke screenreader
        this.describler = new describlerObj(this.svgroot); 
      }
    }

    appObj.prototype.setFileInfo = function ( name, filesize, lastMod ){
        document.getElementById("file-name").innerHTML = "<strong title='last modified: " 
          + lastMod
          + "''>" + escape(name) + "</strong>";
        document.getElementById("filesize").textContent = filesize;
    } 

    appObj.prototype.createSaveLink = function ( svgContent ) {
      if ( svgContent && this.file ) {
        // uses HTML5 features: the ‘Blob’ object and the ‘download’ attribute of the <a> element 
        var blob = new Blob([ svgContent], {type:"image/svg+xml"});
        this.downloadLink.download = this.file.name.replace(".svg", "-svgax.svg");
        this.downloadLink.href = window.URL.createObjectURL(blob);

        document.getElementById("new-filesize").textContent = "(revised: " + this.byteSized( blob.size ) + ")";        
      }
    } 

    appObj.prototype.setScalability = function ( svgEl ) {
      var vb = svgEl.getAttribute("viewBox");
      
      var x = parseFloat( svgEl.getAttribute("x") );
      x = isNaN( x ) ? 0 : x;

      var y = parseFloat( svgEl.getAttribute("y") );
      y = isNaN( y ) ? 0 : y;
      
      var w = parseFloat( svgEl.getAttribute("width") );
      w = isNaN( w ) ? 0 : w;

      var h = parseFloat( svgEl.getAttribute("height") );
      h = isNaN( h ) ? 0 : h;

      var newVB = x + " " + y + " " + w + " " + h;
      if ( 0 == w || 0 == h ) {
        // if width and height not set, use bounding box of SVG contents
        var bbox = svgEl.getBBox();
        newVB = bbox.x + " " + bbox.y + " " + bbox.width + " " + bbox.height;
      }

      svgEl.setAttribute("width", "100%" );
      svgEl.setAttribute("height", "100%" );
      
      var vbArray = vb.split(" ");

      if ( !vb || ( w == vbArray[2] && h == vbArray[3] ) ) {
        svgEl.setAttribute("viewBox", newVB );
      }
    } 

    appObj.prototype.byteSized = function ( bytes ) {
      var units = ["bytes", "KB", "MB", "GB", "TB"];
      var size = ";"
      if ( 0 == bytes) {
        size = "0 Bytes"
      } else {
        var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
        if (0 == i) {
          size = bytes + " " + units[i];
        } else {
          size = (bytes / Math.pow(1024, i)).toFixed(1) + " " + units[i];;
        } 
      }
      return size;
    }
    
    appObj.prototype.optimize = function ( str, decimals ) {
      // str = str.replace()
      // \d+(\.\d)(\d)(\d+)
      
      // result = str.replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
    }


    function bind (scope, fn) {
      return function () {
        return fn.apply( scope, arguments );
      }
    }

  </script>	
</head>
<body>

  <section id="app">
    <h1>Describler</h1>  
    <section id="content"> 
      <section id="controls"> 
        <div class="upload button icon-upload">
            <span>Upload an SVG file…</span>
            <input type="file" id="upload_file-button" accept="image/svg+xml">
        </div>
        <select id="select_file-button" class="upload button">
          <option>Select a file:</option>
        </select>

       <section id="info">
          <output id="file-name"> </output>
          <output id="filesize"> </output>
          <output id="new-filesize"> </output>
        </section>

        <a id="download-button" class="button icon-download download" href="#"><span>Download…</span></a>     

       </section>
    
      <article id="display-area">
        <p><strong>Describler</strong> is an experimental screen reader (audio browser for blind people) for SVG, and specifically SVG data visualizations.</p>

        <h2 id="screenreader">How do I use the Describler screen reader?</h2>
        <p>First, load an SVG image. You can find some <a href="http://describler.com/samples/">sample SVG images on this site</a>.</p>
        <p>Next, tab to the chart. For each focusable item, you will hear a spoken description. <i>Note that this uses the Web Speech API, which is not yet supported by all browsers. Note also that you should be a bit patient; it might take a second or so before the description is read aloud.</i>
        <p>Once the description has been read out, you can press the <code>d</code> key to hear more details about that part of the chart. For some items, such as datapoints, there are multiple levels of details, which you can activate by subsequent presses of the <code>d</code> key.</p>
        <p>Describler also has an experimental sonifier help the user understand the trend of the data visualization, by playing a tone that rises or falls the animated cursor runs along the trend line. You can activate this by pressing the <code>s</code> key to create the trend line, then the <code>p</code> key to "play" the tone.</a>
        
        <h2 id="authoring">How do I make accessible SVGs?</h2>
        <p>Describler also has an <a href="edit.html">online editing tool</a> that helps you to make your SVG images accessible and reusable. It shows you all of the text content of your SVG in an editable list, including both visible text and metadata, and makes it easy for you to add descriptive content, or change the text that's already there. And you can use the “audio preview” feature to hear how your SVG sounds in common screenreaders. The Describler editor also makes your SVG auto-scaling by default, rather than a fixed size; this allows you to use your SVG at whatever size you need, or to change the size dynamically, and it allows users to zoom and pan easily.</p>
        
        <h2 id="svg">What is SVG?</h2>
        <p>SVG stands for Scalable Vector Graphics, and it is a vector-based format, that can be created in popular drawing tools like Inkscape and Adobe Illustrator. Because each shape is made up of one or more markup elements, and the document has a DOM like HTML, it can be styled with CSS, and made interactive or animated with JavaScript.</p>
        <p>Like HTML, the text in SVG is simply text, and so screenreaders can read it. In addition to the visible text elements, like <code>&lt;text&gt;</code>,  <code>&lt;tspan&gt;</code>, and <code>&lt;textPath&gt;</code> elements, SVG has special metadata elements, <code>&lt;title&gt;</code> and <code>&lt;desc&gt;</code>, which allow you to annotate your shapes for mouseover tooltips and special screenreader descriptions.</p>
        <h2 id="using-describler">How do I use Describler to make my SVG accessible?</h2>
        <ol>
          <li><b>Upload your SVG file.</b> Click on the orange button with the up-arrow icon, and select an SVG file.</li>
          <li><b>Add or edit the text, titles, and descriptions.</b> Click on any text in the list view, and edit it. Hit <code>Enter</code> or click off the text to commit your change to the SVG image. To add a title or description to any element, click one of the purple buttons next to that list item. Remember: titles should be short, and descriptions should be longer; don’t duplicate text… write your descriptions just the way you yourself would like to hear the image described.</li>
          <li><b>Listen to the SVG image!</b> Click on the green button with the speaker icon to hear your SVG spoken aloud like a person using a screenreader will hear it. <i>This is an experimental feature in browsers, so you’ll have to <a href="#audio-help">enable it in your browser</a> to use this feature.</i></li>
          <li><b>Save your SVG file.</b> Click on the purple button with the down-arrow icon to save your SVG file locally.</li>
        </ol>
        <h2 id="notes">Notes</h2>
        <p>Describler is meant to add accessibility to SVG images, not to interactive SVG applications or GUIs; use ARIA markup for that.</p>
        <p>For more background on accessible SVG, see my <a href="http://schepers.cc/authoring-accessible-svg ‎">blog post</a>. Suggestions or code improvements are welcome! See the <a href="https://github.com/shepazu/describler">source on github</a>, where you can also check out some <a href="https://github.com/shepazu/describler/tree/gh-pages/samples">sample SVG files to play with.</a></p>
        <p>Thanks! <br>–<a id="sig" href="http://twitter.com/shepazu" target="_blank">Shepazu</a></p>
      </article>
    </section>
  </section>

</body>
</html>